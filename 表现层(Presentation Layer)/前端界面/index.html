<body>
    <!-- 主内容 -->
    <main class="主容器">
        <!-- 你的应用内容 -->
    </main>
    
    <!-- Service Worker 调试面板（开发环境显示） -->
    <div id="sw调试面板" class="sw调试面板" style="display: none;">
        <div class="面板头部">
            <h4><i class="fas fa-cogs"></i> Service Worker 调试</h4>
            <button onclick="toggleDebugPanel()">×</button>
        </div>
        <div class="面板内容">
            <div class="状态信息">
                <div class="状态项">
                    <span class="状态标签">状态:</span>
                    <span id="sw状态" class="状态值">未知</span>
                </div>
                <div class="状态项">
                    <span class="状态标签">版本:</span>
                    <span id="sw版本" class="状态值">-</span>
                </div>
                <div class="状态项">
                    <span class="状态标签">缓存:</span>
                    <span id="sw缓存" class="状态值">-</span>
                </div>
                <div class="状态项">
                    <span class="状态标签">网络:</span>
                    <span id="sw网络" class="状态值">-</span>
                </div>
            </div>
            <div class="控制按钮">
                <button onclick="updateServiceWorker()" class="控制按钮">
                    <i class="fas fa-sync-alt"></i> 检查更新
                </button>
                <button onclick="clearSWCache()" class="控制按钮">
                    <i class="fas fa-trash"></i> 清理缓存
                </button>
                <button onclick="unregisterServiceWorker()" class="控制按钮 危险">
                    <i class="fas fa-ban"></i> 注销
                </button>
            </div>
        </div>
    </div>
    
    <!-- 调试面板样式 -->
    <style>
        .sw调试面板 {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border: 2px solid #2E8B57;
            z-index: 9995;
            overflow: hidden;
        }
        
        .面板头部 {
            background: linear-gradient(135deg, #2E8B57, #4ECDC4);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .面板头部 h4 {
            margin: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .面板头部 button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .面板头部 button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .面板内容 {
            padding: 16px;
        }
        
        .状态信息 {
            margin-bottom: 16px;
        }
        
        .状态项 {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .状态标签 {
            color: #7F8C8D;
        }
        
        .状态值 {
            color: #2C3E50;
            font-weight: 500;
        }
        
        .控制按钮 {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .控制按钮 button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #E8F5E9;
            background: white;
            color: #2C3E50;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .控制按钮 button:hover {
            background: #F8FFF8;
            border-color: #2E8B57;
            transform: translateY(-1px);
        }
        
        .控制按钮 button.危险 {
            border-color: #FFEEBA;
            color: #856404;
        }
        
        .控制按钮 button.危险:hover {
            background: #FFF3CD;
            border-color: #F39C12;
        }
    </style>
    
    <!-- Service Worker 管理脚本 -->
    <script>
        // Service Worker 管理函数
        function toggleDebugPanel() {
            const panel = document.getElementById('sw调试面板');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateServiceWorker() {
            if (window.swRegistration) {
                window.swRegistration.update();
                showNotification('正在检查更新', '请稍候...', 'info');
            } else {
                showNotification('错误', 'Service Worker未注册', 'error');
            }
        }
        
        async function clearSWCache() {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    showNotification('缓存已清理', '所有缓存已被清除', 'success');
                    updateSWStatus();
                } catch (error) {
                    showNotification('清理失败', error.message, 'error');
                }
            }
        }
        
        async function unregisterServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(r => r.unregister()));
                    
                    // 清理缓存
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                    }
                    
                    showNotification('已注销', 'Service Worker已注销', 'success');
                    window.location.reload();
                } catch (error) {
                    showNotification('注销失败', error.message, 'error');
                }
            }
        }
        
        function updateSWStatus() {
            // 更新状态显示
            const stateEl = document.getElementById('sw状态');
            const versionEl = document.getElementById('sw版本');
            const cacheEl = document.getElementById('sw缓存');
            const networkEl = document.getElementById('sw网络');
            
            if (navigator.serviceWorker.controller) {
                stateEl.textContent = '已激活';
                stateEl.style.color = '#27AE60';
            } else if (window.swRegistration) {
                stateEl.textContent = '已注册';
                stateEl.style.color = '#F39C12';
            } else {
                stateEl.textContent = '未注册';
                stateEl.style.color = '#E74C3C';
            }
            
            versionEl.textContent = '1.0.0';
            networkEl.textContent = navigator.onLine ? '在线' : '离线';
            networkEl.style.color = navigator.onLine ? '#27AE60' : '#E74C3C';
            
            // 获取缓存信息
            getCacheInfo().then(info => {
                cacheEl.textContent = info || '未知';
            });
        }
        
        async function getCacheInfo() {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    let totalSize = 0;
                    
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const requests = await cache.keys();
                        for (const request of requests) {
                            const response = await cache.match(request);
                            if (response) {
                                const contentLength = response.headers.get('content-length');
                                if (contentLength) {
                                    totalSize += parseInt(contentLength);
                                }
                            }
                        }
                    }
                    
                    if (totalSize < 1024) {
                        return `${totalSize} B`;
                    } else if (totalSize < 1024 * 1024) {
                        return `${(totalSize / 1024).toFixed(1)} KB`;
                    } else {
                        return `${(totalSize / (1024 * 1024)).toFixed(2)} MB`;
                    }
                } catch (error) {
                    return '错误';
                }
            }
            return '不支持';
        }
        
        // 初始化状态更新
        setInterval(updateSWStatus, 5000);
        
        // 页面加载完成后显示调试面板（仅开发环境）
        window.addEventListener('load', () => {
            // 如果是本地环境或调试模式，显示调试面板
            if (window.location.hostname === 'localhost' || 
                window.location.hostname === '127.0.0.1' ||
                window.location.search.includes('debug=true')) {
                document.getElementById('sw调试面板').style.display = 'block';
                updateSWStatus();
            }
        });
    </script>
</body>
</html>
